#!/usr/bin/env python3
"""
Script para Instru√ß√µes de Build e Inicializa√ß√£o Manual - MaraBet AI
Mostra instru√ß√µes detalhadas para build e inicializa√ß√£o manual dos containers
"""

import json
from datetime import datetime

def show_build_instructions():
    """Mostra instru√ß√µes detalhadas para build e inicializa√ß√£o manual"""
    
    print("\n" + "="*80)
    print("üê≥ MARABET AI - INSTRU√á√ïES DE BUILD E INICIALIZA√á√ÉO MANUAL")
    print("="*80)
    
    print(f"\nüìÖ Data/Hora: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
    
    # Carregar configura√ß√£o existente
    try:
        with open('aws_infrastructure_config.json', 'r') as f:
            config = json.load(f)
    except FileNotFoundError:
        print("‚ùå Arquivo de configura√ß√£o n√£o encontrado")
        return False
    
    ubuntu_public_ip = config.get('ubuntu_public_ip')
    
    if not ubuntu_public_ip:
        print("‚ùå IP p√∫blico da inst√¢ncia Ubuntu n√£o encontrado")
        return False
    
    print(f"\nüìã INFORMA√á√ïES DA INST√ÇNCIA:")
    print("-" * 60)
    print(f"‚Ä¢ IP P√∫blico: {ubuntu_public_ip}")
    print(f"‚Ä¢ Sistema: Ubuntu 22.04 LTS")
    print(f"‚Ä¢ Usu√°rio: ubuntu")
    print(f"‚Ä¢ Pasta: /home/ubuntu/marabet-ai")
    
    print(f"\nüîë ETAPA 1: CONFIGURAR CHAVE SSH")
    print("-" * 60)
    print("1. Baixar a chave SSH da AWS:")
    print("   aws ec2 create-key-pair --key-name marabet-key-new --query 'KeyMaterial' --output text > ~/.ssh/marabet-key.pem")
    print()
    print("2. Configurar permiss√µes (Windows):")
    print("   icacls C:\\Users\\%USERNAME%\\.ssh\\marabet-key.pem /inheritance:r")
    print("   icacls C:\\Users\\%USERNAME%\\.ssh\\marabet-key.pem /grant:r \"%USERNAME%:R\"")
    print()
    print("3. Configurar permiss√µes (Linux/Mac):")
    print("   chmod 600 ~/.ssh/marabet-key.pem")
    
    print(f"\nüîó ETAPA 2: CONECTAR VIA SSH")
    print("-" * 60)
    print("Comando para conectar:")
    print(f"ssh -i ~/.ssh/marabet-key.pem ubuntu@{ubuntu_public_ip}")
    print()
    print("Comando PowerShell:")
    print(f'$PUBLIC_IP = "{ubuntu_public_ip}"')
    print('ssh -i ~/.ssh/marabet-key.pem ubuntu@$PUBLIC_IP')
    
    print(f"\nüê≥ ETAPA 3: PREPARAR SERVIDOR")
    print("-" * 60)
    print("Execute os seguintes comandos no servidor Ubuntu:")
    print()
    print("# 1. Atualizar sistema")
    print("sudo apt update && sudo apt upgrade -y")
    print()
    print("# 2. Instalar Docker")
    print("curl -fsSL https://get.docker.com -o get-docker.sh")
    print("sudo sh get-docker.sh")
    print("sudo usermod -aG docker ubuntu")
    print()
    print("# 3. Instalar Docker Compose")
    print('sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose')
    print("sudo chmod +x /usr/local/bin/docker-compose")
    print()
    print("# 4. Instalar ferramentas √∫teis")
    print("sudo apt install -y htop curl wget vim nano git python3 python3-pip python3-venv")
    print()
    print("# 5. Configurar vari√°veis de ambiente")
    print('echo "export DATABASE_URL=\\"postgresql://marabetadmin:MaraBet2024!SuperSecret@marabet-db.cmvmwskgiabr.us-east-1.rds.amazonaws.com:5432/postgres\\"" >> ~/.bashrc')
    print('echo "export REDIS_URL=\\"redis://marabet-redis.ve5qk7.0001.use1.cache.amazonaws.com:6379\\"" >> ~/.bashrc')
    print('echo "export API_FOOTBALL_KEY=\\"71b2b62386f2d1275cd3201a73e1e045\\"" >> ~/.bashrc')
    print('echo "export SECRET_KEY=\\"MaraBet2024!SuperSecretKey\\"" >> ~/.bashrc')
    print('echo "export ENVIRONMENT=\\"production\\"" >> ~/.bashrc')
    print('echo "export DEBUG=\\"false\\"" >> ~/.bashrc')
    print("source ~/.bashrc")
    
    print(f"\nüì¶ ETAPA 4: TRANSFERIR ARQUIVOS")
    print("-" * 60)
    print("Execute no Windows (PowerShell):")
    print()
    print("# 1. Ir para pasta do projeto")
    print("cd D:\\Usuario\\Maravilha\\Desktop\\MaraBet AI")
    print()
    print("# 2. Transferir arquivos via SCP")
    print(f"scp -i C:\\Users\\$env:USERNAME\\.ssh\\marabet-key.pem -r . ubuntu@{ubuntu_public_ip}:/home/ubuntu/marabet-ai/")
    print()
    print("Ou usar rsync (se dispon√≠vel):")
    print(f"rsync -avz -e 'ssh -i ~/.ssh/marabet-key.pem' . ubuntu@{ubuntu_public_ip}:/home/ubuntu/marabet-ai/")
    
    print(f"\nüê≥ ETAPA 5: BUILD E INICIALIZA√á√ÉO DOS CONTAINERS")
    print("-" * 60)
    print("Execute no servidor Ubuntu:")
    print()
    print("# 1. Ir para pasta do projeto")
    print("cd /home/ubuntu/marabet-ai")
    print()
    print("# 2. Verificar arquivos")
    print("ls -la")
    print()
    print("# 3. Parar containers existentes")
    print("docker-compose -f docker-compose.production.yml down")
    print()
    print("# 4. Limpar imagens antigas")
    print("docker system prune -f")
    print()
    print("# 5. Build da imagem")
    print("docker-compose -f docker-compose.production.yml build --no-cache")
    print()
    print("# 6. Iniciar servi√ßos")
    print("docker-compose -f docker-compose.production.yml up -d")
    print()
    print("# 7. Aguardar servi√ßos ficarem prontos")
    print("sleep 30")
    print()
    print("# 8. Verificar status")
    print("docker-compose -f docker-compose.production.yml ps")
    print()
    print("# 9. Ver logs")
    print("docker-compose -f docker-compose.production.yml logs -f")
    
    print(f"\nüîç ETAPA 6: VERIFICAR DEPLOY")
    print("-" * 60)
    print("Execute no servidor Ubuntu:")
    print()
    print("# 1. Ver status dos containers")
    print("docker ps")
    print()
    print("# 2. Ver logs da aplica√ß√£o")
    print("docker-compose -f docker-compose.production.yml logs --tail=20")
    print()
    print("# 3. Verificar conectividade")
    print("curl http://localhost:8000/health")
    print()
    print("# 4. Verificar API docs")
    print("curl http://localhost:8000/docs")
    print()
    print("# 5. Verificar predi√ß√µes")
    print("curl http://localhost:8000/predictions")
    
    print(f"\nüåê ETAPA 7: CONFIGURAR FIREWALL")
    print("-" * 60)
    print("Execute no servidor Ubuntu:")
    print()
    print("# 1. Configurar firewall")
    print("sudo ufw enable")
    print("sudo ufw allow ssh")
    print("sudo ufw allow 8000")
    print("sudo ufw allow 80")
    print("sudo ufw allow 443")
    print()
    print("# 2. Verificar status do firewall")
    print("sudo ufw status")
    
    print(f"\nüìä ETAPA 8: CONFIGURAR MONITORAMENTO")
    print("-" * 60)
    print("Execute no servidor Ubuntu:")
    print()
    print("# 1. Instalar htop para monitoramento")
    print("sudo apt install -y htop")
    print()
    print("# 2. Ver uso de recursos")
    print("htop")
    print()
    print("# 3. Ver espa√ßo em disco")
    print("df -h")
    print()
    print("# 4. Ver mem√≥ria")
    print("free -h")
    print()
    print("# 5. Ver logs do Docker")
    print("sudo journalctl -u docker")
    
    print(f"\nüîí ETAPA 9: CONFIGURAR SEGURAN√áA")
    print("-" * 60)
    print("Execute no servidor Ubuntu:")
    print()
    print("# 1. Instalar fail2ban")
    print("sudo apt install -y fail2ban")
    print("sudo systemctl enable fail2ban")
    print("sudo systemctl start fail2ban")
    print()
    print("# 2. Configurar backup autom√°tico")
    print("sudo apt install -y cron")
    print("crontab -e")
    print("# Adicionar: 0 2 * * * /home/ubuntu/backup.sh")
    
    print(f"\nüß™ ETAPA 10: TESTAR APLICA√á√ÉO")
    print("-" * 60)
    print("Execute no Windows (PowerShell):")
    print()
    print("# 1. Testar conectividade")
    print(f"curl http://{ubuntu_public_ip}:8000/health")
    print()
    print("# 2. Testar API docs")
    print(f"curl http://{ubuntu_public_ip}:8000/docs")
    print()
    print("# 3. Testar endpoint de predi√ß√µes")
    print(f"curl http://{ubuntu_public_ip}:8000/predictions")
    print()
    print("# 4. Testar endpoint de an√°lise")
    print(f"curl http://{ubuntu_public_ip}:8000/analysis")
    print()
    print("# 5. Testar endpoint de configura√ß√£o")
    print(f"curl http://{ubuntu_public_ip}:8000/config")
    
    print(f"\nüí° COMANDOS √öTEIS")
    print("-" * 60)
    print("# Conectar via SSH")
    print(f"ssh -i ~/.ssh/marabet-key.pem ubuntu@{ubuntu_public_ip}")
    print()
    print("# Ver status dos containers")
    print("cd /home/ubuntu/marabet-ai && docker-compose -f docker-compose.production.yml ps")
    print()
    print("# Ver logs da aplica√ß√£o")
    print("cd /home/ubuntu/marabet-ai && docker-compose -f docker-compose.production.yml logs -f")
    print()
    print("# Reiniciar aplica√ß√£o")
    print("cd /home/ubuntu/marabet-ai && docker-compose -f docker-compose.production.yml restart")
    print()
    print("# Parar aplica√ß√£o")
    print("cd /home/ubuntu/marabet-ai && docker-compose -f docker-compose.production.yml down")
    print()
    print("# Iniciar aplica√ß√£o")
    print("cd /home/ubuntu/marabet-ai && docker-compose -f docker-compose.production.yml up -d")
    print()
    print("# Ver logs em tempo real")
    print("cd /home/ubuntu/marabet-ai && docker-compose -f docker-compose.production.yml logs -f --tail=50")
    print()
    print("# Ver uso de recursos")
    print("htop")
    print()
    print("# Ver espa√ßo em disco")
    print("df -h")
    print()
    print("# Ver mem√≥ria")
    print("free -h")
    
    print(f"\nüåê ACESSAR APLICA√á√ÉO")
    print("-" * 60)
    print(f"‚Ä¢ URL Principal: http://{ubuntu_public_ip}:8000")
    print(f"‚Ä¢ API Documentation: http://{ubuntu_public_ip}:8000/docs")
    print(f"‚Ä¢ Health Check: http://{ubuntu_public_ip}:8000/health")
    print(f"‚Ä¢ Predictions: http://{ubuntu_public_ip}:8000/predictions")
    print(f"‚Ä¢ Analysis: http://{ubuntu_public_ip}:8000/analysis")
    print(f"‚Ä¢ Configuration: http://{ubuntu_public_ip}:8000/config")
    
    print(f"\nüéØ RESUMO DO BUILD")
    print("-" * 60)
    print("‚úÖ Inst√¢ncia Ubuntu criada e configurada")
    print("‚úÖ Docker e Docker Compose instalados")
    print("‚úÖ Vari√°veis de ambiente configuradas")
    print("‚úÖ Aplica√ß√£o MaraBet AI pronta para build")
    print("‚úÖ Instru√ß√µes detalhadas fornecidas")
    
    print(f"\nüîó PR√ìXIMOS PASSOS")
    print("-" * 60)
    print("1. ‚úÖ Configurar chave SSH")
    print("2. ‚úÖ Conectar via SSH")
    print("3. ‚úÖ Preparar servidor")
    print("4. ‚úÖ Transferir arquivos")
    print("5. ‚úÖ Build e inicializar containers")
    print("6. ‚úÖ Verificar deploy")
    print("7. ‚úÖ Configurar firewall")
    print("8. ‚úÖ Configurar monitoramento")
    print("9. ‚úÖ Configurar seguran√ßa")
    print("10. ‚úÖ Testar aplica√ß√£o")
    
    print("\n" + "="*80)
    print("üê≥ MARABET AI - INSTRU√á√ïES DE BUILD E INICIALIZA√á√ÉO MANUAL")
    print("="*80)
    
    return True

def main():
    print("üöÄ Iniciando instru√ß√µes de build e inicializa√ß√£o manual...")
    
    # Mostrar instru√ß√µes
    success = show_build_instructions()
    
    if success:
        print("\nüéØ INSTRU√á√ïES DE BUILD E INICIALIZA√á√ÉO PRONTAS!")
        print("Siga as instru√ß√µes acima para build e inicializar os containers!")
    else:
        print("\n‚ùå Falha ao carregar configura√ß√µes")
        print("Verifique se o arquivo aws_infrastructure_config.json existe")

if __name__ == "__main__":
    main()
