<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimização de Hiperparâmetros - MaraBet AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .optimization-card {
            transition: transform 0.2s;
        }
        .optimization-card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-size: 0.8em;
        }
        .progress-custom {
            height: 8px;
        }
        .model-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .optimization-log {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid #007bff;
            background-color: white;
            border-radius: 3px;
        }
        .log-error {
            border-left-color: #dc3545;
        }
        .log-success {
            border-left-color: #28a745;
        }
        .log-warning {
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="fas fa-cogs me-2"></i>Otimização de Hiperparâmetros</h1>
                    <div>
                        <button class="btn btn-primary me-2" onclick="showNewOptimizationModal()">
                            <i class="fas fa-plus me-1"></i>Nova Otimização
                        </button>
                        <button class="btn btn-outline-secondary" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card optimization-card">
                    <div class="card-body text-center">
                        <i class="fas fa-play-circle text-primary model-icon"></i>
                        <h5 class="card-title">Em Execução</h5>
                        <h3 class="text-primary" id="running-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card optimization-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle text-success model-icon"></i>
                        <h5 class="card-title">Concluídas</h5>
                        <h3 class="text-success" id="completed-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card optimization-card">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle text-warning model-icon"></i>
                        <h5 class="card-title">Com Erro</h5>
                        <h3 class="text-warning" id="failed-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card optimization-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line text-info model-icon"></i>
                        <h5 class="card-title">Melhor Score</h5>
                        <h3 class="text-info" id="best-score">0.0000</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>Progresso das Otimizações</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>Distribuição por Modelo</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="modelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization List -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Otimizações Ativas</h5>
                    </div>
                    <div class="card-body">
                        <div id="optimization-list">
                            <!-- Lista será preenchida dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal me-2"></i>Log de Atividades</h5>
                    </div>
                    <div class="card-body">
                        <div class="optimization-log" id="optimization-log">
                            <!-- Log será preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nova Otimização -->
    <div class="modal fade" id="newOptimizationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Otimização de Hiperparâmetros</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="optimizationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="modelName" class="form-label">Modelo</label>
                                    <select class="form-select" id="modelName" required>
                                        <option value="">Selecione um modelo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studyName" class="form-label">Nome do Estudo</label>
                                    <input type="text" class="form-control" id="studyName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nTrials" class="form-label">Número de Tentativas</label>
                                    <input type="number" class="form-control" id="nTrials" value="100" min="1" max="1000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="timeout" class="form-label">Timeout (segundos)</label>
                                    <input type="number" class="form-control" id="timeout" min="60">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cvStrategy" class="form-label">Estratégia de Validação</label>
                                    <select class="form-select" id="cvStrategy">
                                        <option value="time_series">Time Series Cross-Validation</option>
                                        <option value="purged">Purged Cross-Validation</option>
                                        <option value="walk_forward">Walk-Forward Analysis</option>
                                        <option value="monte_carlo">Monte Carlo Cross-Validation</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scoring" class="form-label">Métrica de Avaliação</label>
                                    <select class="form-select" id="scoring">
                                        <option value="accuracy">Accuracy</option>
                                        <option value="precision">Precision</option>
                                        <option value="recall">Recall</option>
                                        <option value="f1">F1-Score</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="multiModel">
                                <label class="form-check-label" for="multiModel">
                                    Otimizar múltiplos modelos
                                </label>
                            </div>
                        </div>
                        <div id="multiModelSettings" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Modelos para Otimizar</label>
                                <div id="modelCheckboxes">
                                    <!-- Checkboxes serão preenchidos dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="startOptimization()">Iniciar Otimização</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalhes da Otimização -->
    <div class="modal fade" id="optimizationDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Otimização</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="optimization-details">
                        <!-- Detalhes serão preenchidos dinamicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="exportResults()">Exportar Resultados</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais
        let progressChart = null;
        let modelChart = null;
        let currentOptimizations = [];
        let logEntries = [];

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSupportedModels();
            loadOptimizations();
            initializeCharts();
            startAutoRefresh();
        });

        // Carregar modelos suportados
        async function loadSupportedModels() {
            try {
                const response = await fetch('/optimization/models');
                const data = await response.json();
                
                const modelSelect = document.getElementById('modelName');
                const modelCheckboxes = document.getElementById('modelCheckboxes');
                
                data.models.forEach(model => {
                    // Select para modelo único
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.display_name;
                    modelSelect.appendChild(option);
                    
                    // Checkboxes para múltiplos modelos
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'form-check';
                    checkboxDiv.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${model.name}" id="model_${model.name}">
                        <label class="form-check-label" for="model_${model.name}">
                            ${model.display_name}
                        </label>
                    `;
                    modelCheckboxes.appendChild(checkboxDiv);
                });
            } catch (error) {
                console.error('Erro ao carregar modelos:', error);
                addLogEntry('Erro ao carregar modelos suportados', 'error');
            }
        }

        // Carregar otimizações
        async function loadOptimizations() {
            try {
                // Simular dados (em produção, buscar da API)
                currentOptimizations = [
                    {
                        id: 'task_1',
                        model_name: 'random_forest',
                        study_name: 'rf_optimization_1',
                        status: 'running',
                        progress: 65,
                        best_score: 0.8542,
                        start_time: new Date().toISOString(),
                        n_trials: 100
                    },
                    {
                        id: 'task_2',
                        model_name: 'xgboost',
                        study_name: 'xgb_optimization_1',
                        status: 'completed',
                        progress: 100,
                        best_score: 0.8765,
                        start_time: new Date(Date.now() - 3600000).toISOString(),
                        n_trials: 100
                    }
                ];
                
                updateOptimizationList();
                updateStatusCards();
            } catch (error) {
                console.error('Erro ao carregar otimizações:', error);
                addLogEntry('Erro ao carregar otimizações', 'error');
            }
        }

        // Atualizar lista de otimizações
        function updateOptimizationList() {
            const container = document.getElementById('optimization-list');
            container.innerHTML = '';
            
            currentOptimizations.forEach(opt => {
                const card = createOptimizationCard(opt);
                container.appendChild(card);
            });
        }

        // Criar card de otimização
        function createOptimizationCard(opt) {
            const card = document.createElement('div');
            card.className = 'card mb-3 optimization-card';
            
            const statusClass = {
                'running': 'primary',
                'completed': 'success',
                'failed': 'danger',
                'pending': 'warning'
            }[opt.status] || 'secondary';
            
            const statusIcon = {
                'running': 'fa-play-circle',
                'completed': 'fa-check-circle',
                'failed': 'fa-exclamation-circle',
                'pending': 'fa-clock'
            }[opt.status] || 'fa-question-circle';
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <i class="fas ${statusIcon} text-${statusClass} fa-2x"></i>
                        </div>
                        <div class="col-md-3">
                            <h6 class="card-title">${opt.model_name.replace('_', ' ').toUpperCase()}</h6>
                            <small class="text-muted">${opt.study_name}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-${statusClass} status-badge">${opt.status.toUpperCase()}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Score: ${opt.best_score.toFixed(4)}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="progress progress-custom">
                                <div class="progress-bar bg-${statusClass}" style="width: ${opt.progress}%"></div>
                            </div>
                            <small class="text-muted">${opt.progress}%</small>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="showOptimizationDetails('${opt.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Atualizar cards de status
        function updateStatusCards() {
            const running = currentOptimizations.filter(opt => opt.status === 'running').length;
            const completed = currentOptimizations.filter(opt => opt.status === 'completed').length;
            const failed = currentOptimizations.filter(opt => opt.status === 'failed').length;
            const bestScore = Math.max(...currentOptimizations.map(opt => opt.best_score || 0));
            
            document.getElementById('running-count').textContent = running;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('failed-count').textContent = failed;
            document.getElementById('best-score').textContent = bestScore.toFixed(4);
        }

        // Inicializar gráficos
        function initializeCharts() {
            // Gráfico de progresso
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Score',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
            
            // Gráfico de distribuição por modelo
            const modelCtx = document.getElementById('modelChart').getContext('2d');
            modelChart = new Chart(modelCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            updateCharts();
        }

        // Atualizar gráficos
        function updateCharts() {
            // Atualizar gráfico de progresso
            const completedOpts = currentOptimizations.filter(opt => opt.status === 'completed');
            const labels = completedOpts.map(opt => opt.study_name);
            const scores = completedOpts.map(opt => opt.best_score);
            
            progressChart.data.labels = labels;
            progressChart.data.datasets[0].data = scores;
            progressChart.update();
            
            // Atualizar gráfico de distribuição por modelo
            const modelCounts = {};
            currentOptimizations.forEach(opt => {
                modelCounts[opt.model_name] = (modelCounts[opt.model_name] || 0) + 1;
            });
            
            modelChart.data.labels = Object.keys(modelCounts);
            modelChart.data.datasets[0].data = Object.values(modelCounts);
            modelChart.update();
        }

        // Mostrar modal de nova otimização
        function showNewOptimizationModal() {
            const modal = new bootstrap.Modal(document.getElementById('newOptimizationModal'));
            modal.show();
        }

        // Alternar configurações de múltiplos modelos
        document.getElementById('multiModel').addEventListener('change', function() {
            const multiSettings = document.getElementById('multiModelSettings');
            const modelSelect = document.getElementById('modelName');
            
            if (this.checked) {
                multiSettings.style.display = 'block';
                modelSelect.disabled = true;
            } else {
                multiSettings.style.display = 'none';
                modelSelect.disabled = false;
            }
        });

        // Iniciar otimização
        async function startOptimization() {
            const form = document.getElementById('optimizationForm');
            const formData = new FormData(form);
            
            const isMultiModel = document.getElementById('multiModel').checked;
            
            try {
                if (isMultiModel) {
                    const selectedModels = Array.from(document.querySelectorAll('#modelCheckboxes input:checked'))
                        .map(cb => cb.value);
                    
                    if (selectedModels.length === 0) {
                        alert('Selecione pelo menos um modelo');
                        return;
                    }
                    
                    const response = await fetch('/optimization/start-multi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model_names: selectedModels,
                            study_name: document.getElementById('studyName').value,
                            n_trials: parseInt(document.getElementById('nTrials').value),
                            timeout: parseInt(document.getElementById('timeout').value) || null,
                            cv_strategy: document.getElementById('cvStrategy').value,
                            scoring: document.getElementById('scoring').value
                        })
                    });
                    
                    const result = await response.json();
                    addLogEntry(`Otimização multi-modelo iniciada: ${result.task_id}`, 'success');
                } else {
                    const response = await fetch('/optimization/start-single', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model_name: document.getElementById('modelName').value,
                            study_name: document.getElementById('studyName').value,
                            n_trials: parseInt(document.getElementById('nTrials').value),
                            timeout: parseInt(document.getElementById('timeout').value) || null,
                            cv_strategy: document.getElementById('cvStrategy').value,
                            scoring: document.getElementById('scoring').value
                        })
                    });
                    
                    const result = await response.json();
                    addLogEntry(`Otimização iniciada: ${result.task_id}`, 'success');
                }
                
                // Fechar modal e atualizar dados
                bootstrap.Modal.getInstance(document.getElementById('newOptimizationModal')).hide();
                form.reset();
                loadOptimizations();
                
            } catch (error) {
                console.error('Erro ao iniciar otimização:', error);
                addLogEntry('Erro ao iniciar otimização', 'error');
            }
        }

        // Mostrar detalhes da otimização
        function showOptimizationDetails(optimizationId) {
            const opt = currentOptimizations.find(o => o.id === optimizationId);
            if (!opt) return;
            
            const detailsContainer = document.getElementById('optimization-details');
            detailsContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Gerais</h6>
                        <table class="table table-sm">
                            <tr><td>ID:</td><td>${opt.id}</td></tr>
                            <tr><td>Modelo:</td><td>${opt.model_name}</td></tr>
                            <tr><td>Estudo:</td><td>${opt.study_name}</td></tr>
                            <tr><td>Status:</td><td><span class="badge bg-primary">${opt.status}</span></td></tr>
                            <tr><td>Progresso:</td><td>${opt.progress}%</td></tr>
                            <tr><td>Melhor Score:</td><td>${opt.best_score.toFixed(4)}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Parâmetros</h6>
                        <table class="table table-sm">
                            <tr><td>Tentativas:</td><td>${opt.n_trials}</td></tr>
                            <tr><td>Iniciado em:</td><td>${new Date(opt.start_time).toLocaleString()}</td></tr>
                            <tr><td>Estratégia CV:</td><td>Time Series</td></tr>
                            <tr><td>Métrica:</td><td>Accuracy</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Histórico de Otimização</h6>
                        <div class="chart-container">
                            <canvas id="optimizationHistoryChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('optimizationDetailsModal'));
            modal.show();
        }

        // Exportar resultados
        function exportResults() {
            // Implementar exportação
            addLogEntry('Exportação de resultados iniciada', 'info');
        }

        // Adicionar entrada no log
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                message,
                type
            };
            
            logEntries.unshift(entry);
            if (logEntries.length > 100) {
                logEntries = logEntries.slice(0, 100);
            }
            
            updateLogDisplay();
        }

        // Atualizar exibição do log
        function updateLogDisplay() {
            const container = document.getElementById('optimization-log');
            container.innerHTML = '';
            
            logEntries.forEach(entry => {
                const div = document.createElement('div');
                div.className = `log-entry log-${entry.type}`;
                div.innerHTML = `
                    <small class="text-muted">[${entry.timestamp}]</small>
                    <span>${entry.message}</span>
                `;
                container.appendChild(div);
            });
        }

        // Atualizar dados automaticamente
        function startAutoRefresh() {
            setInterval(() => {
                loadOptimizations();
                updateCharts();
            }, 30000); // Atualizar a cada 30 segundos
        }

        // Atualizar dados manualmente
        function refreshData() {
            loadOptimizations();
            updateCharts();
            addLogEntry('Dados atualizados', 'info');
        }

        // Inicializar log com algumas entradas
        addLogEntry('Dashboard de otimização carregado', 'success');
        addLogEntry('Aguardando otimizações...', 'info');
    </script>
</body>
</html>
