<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaraBet AI Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .main-content {
            background-color: #f8f9fa;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        .prediction-card {
            border-left: 4px solid #28a745;
        }
        .prediction-card.negative {
            border-left-color: #dc3545;
        }
        .match-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .match-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8em;
        }
        .ev-positive {
            color: #28a745;
            font-weight: bold;
        }
        .ev-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .confidence-bar {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
        }
        .confidence-fill {
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-chart-line me-2"></i>
                        MaraBet AI
                    </h4>
                    
                    <!-- User Info -->
                    {% if is_authenticated and user %}
                    <div class="text-center mb-4 p-3 bg-white bg-opacity-10 rounded">
                        <div class="mb-2">
                            <i class="fas fa-user-circle fa-3x text-white"></i>
                        </div>
                        <h6 class="text-white mb-1">{{ user.full_name or user.username }}</h6>
                        <small class="text-white-50">{{ user.email }}</small>
                        <div class="mt-2">
                            <span class="badge bg-{% if user.role == 'admin' %}danger{% elif user.role == 'moderator' %}warning{% else %}info{% endif %}">
                                {{ user.role|title }}
                            </span>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-light btn-sm me-2" onclick="showUserProfile()">
                                <i class="fas fa-user me-1"></i>Perfil
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-1"></i>Sair
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center mb-4 p-3 bg-white bg-opacity-10 rounded">
                        <div class="mb-3">
                            <i class="fas fa-user-circle fa-3x text-white"></i>
                        </div>
                        <p class="text-white-50 mb-3">Faça login para acessar todas as funcionalidades</p>
                        <div class="d-grid gap-2">
                            <a href="/login" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-sign-in-alt me-1"></i>Entrar
                            </a>
                            <a href="/register" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-user-plus me-1"></i>Registrar
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white active" href="#dashboard" onclick="showSection('dashboard')">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#predictions" onclick="showSection('predictions')">
                                <i class="fas fa-crystal-ball me-2"></i>
                                Predições
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#matches" onclick="showSection('matches')">
                                <i class="fas fa-futbol me-2"></i>
                                Partidas
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#performance" onclick="showSection('performance')">
                                <i class="fas fa-chart-bar me-2"></i>
                                Performance
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="/optimization" target="_blank">
                                <i class="fas fa-cogs me-2"></i>
                                Otimização ML
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link text-white" href="#settings" onclick="showSection('settings')">
                                <i class="fas fa-cog me-2"></i>
                                Configurações
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 main-content p-4">
                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>Atualizar
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="toggleCollector()">
                                <i class="fas fa-play me-1"></i>Coletor
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card p-3">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-primary me-3">
                                        <i class="fas fa-futbol"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">{{ stats.total_matches }}</h5>
                                        <small class="text-muted">Partidas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card p-3">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-success me-3">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">{{ stats.total_odds }}</h5>
                                        <small class="text-muted">Odds</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card p-3">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-warning me-3">
                                        <i class="fas fa-crystal-ball"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">{{ stats.total_predictions }}</h5>
                                        <small class="text-muted">Predições</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card p-3">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-info me-3">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">{{ stats.recommended_predictions }}</h5>
                                        <small class="text-muted">Recomendadas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="stat-card p-3">
                                <h5>Predições por Mercado</h5>
                                <canvas id="marketChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-card p-3">
                                <h5>Performance</h5>
                                <canvas id="performanceChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Predictions -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="stat-card p-3">
                                <h5><i class="fas fa-crystal-ball me-2"></i>Predições Recentes</h5>
                                <div id="recent-predictions">
                                    {% for pred in recent_predictions %}
                                    <div class="prediction-card p-3 mb-3 {% if pred.expected_value < 0 %}negative{% endif %}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    {{ pred.match.home_team_name if pred.match else 'N/A' }} vs 
                                                    {{ pred.match.away_team_name if pred.match else 'N/A' }}
                                                </h6>
                                                <p class="mb-1">
                                                    <strong>{{ pred.market }}</strong> - {{ pred.selection }}
                                                </p>
                                                <small class="text-muted">
                                                    {{ pred.match.league_name if pred.match else 'N/A' }} - 
                                                    {{ pred.created_at.strftime('%d/%m/%Y %H:%M') }}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <div class="mb-1">
                                                    <span class="{% if pred.expected_value > 0 %}ev-positive{% else %}ev-negative{% endif %}">
                                                        EV: {{ (pred.expected_value * 100)|round(1) }}%
                                                    </span>
                                                </div>
                                                <div class="mb-1">
                                                    <small>Confiança: {{ (pred.confidence * 100)|round(1) }}%</small>
                                                </div>
                                                <div class="mb-1">
                                                    <small>Stake: {{ (pred.stake_percentage * 100)|round(1) }}%</small>
                                                </div>
                                                <div class="confidence-bar mb-1" style="width: 100px;">
                                                    <div class="confidence-fill" style="width: {{ (pred.confidence * 100)|round(1) }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card p-3">
                                <h5><i class="fas fa-futbol me-2"></i>Partidas de Hoje</h5>
                                <div id="today-matches">
                                    {% for match in today_matches %}
                                    <div class="match-card p-2 mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">{{ match.league_name }}</small>
                                                <div class="fw-bold">
                                                    {{ match.home_team_name }} vs {{ match.away_team_name }}
                                                </div>
                                                <small class="text-muted">
                                                    {{ match.date.strftime('%H:%M') }}
                                                </small>
                                            </div>
                                            <span class="badge bg-{% if match.status == 'LIVE' %}danger{% elif match.status == 'NS' %}primary{% else %}secondary{% endif %} status-badge">
                                                {{ match.status }}
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections will be added here -->
                <div id="predictions-section" style="display: none;">
                    <h2><i class="fas fa-crystal-ball me-2"></i>Predições</h2>
                    <div id="predictions-content">
                        <!-- Will be loaded dynamically -->
                    </div>
                </div>

                <div id="matches-section" style="display: none;">
                    <h2><i class="fas fa-futbol me-2"></i>Partidas</h2>
                    <div id="matches-content">
                        <!-- Will be loaded dynamically -->
                    </div>
                </div>

                <div id="performance-section" style="display: none;">
                    <h2><i class="fas fa-chart-bar me-2"></i>Performance</h2>
                    <div id="performance-content">
                        <!-- Will be loaded dynamically -->
                    </div>
                </div>

                <div id="settings-section" style="display: none;">
                    <h2><i class="fas fa-cog me-2"></i>Configurações</h2>
                    <div id="settings-content">
                        <!-- Will be loaded dynamically -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let collectorStatus = false;
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadCharts();
            checkCollectorStatus();
            setInterval(refreshData, 30000); // Refresh every 30 seconds
        });

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(section + '-section').style.display = 'block';
            
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('active');
            });
            event.target.classList.add('active');

            // Load section content if needed
            if (section === 'predictions') {
                loadPredictions();
            } else if (section === 'matches') {
                loadMatches();
            } else if (section === 'performance') {
                loadPerformance();
            } else if (section === 'settings') {
                loadSettings();
            }
        }

        // Load charts
        function loadCharts() {
            // Market Chart
            const marketCtx = document.getElementById('marketChart').getContext('2d');
            charts.market = new Chart(marketCtx, {
                type: 'doughnut',
                data: {
                    labels: ['H2H', 'Over/Under', 'BTTS'],
                    datasets: [{
                        data: [12, 8, 5],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            charts.performance = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'ROI %',
                        data: [2.5, 3.1, 2.8, 4.2, 3.9, 4.5],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Refresh data
        async function refreshData() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                // Update stats cards
                document.querySelector('.stat-card:nth-child(1) h5').textContent = stats.total_matches;
                document.querySelector('.stat-card:nth-child(2) h5').textContent = stats.total_odds;
                document.querySelector('.stat-card:nth-child(3) h5').textContent = stats.total_predictions;
                document.querySelector('.stat-card:nth-child(4) h5').textContent = stats.recommended_predictions;
                
                // Update charts if needed
                if (stats.markets) {
                    updateMarketChart(stats.markets);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // Update market chart
        function updateMarketChart(markets) {
            if (charts.market) {
                charts.market.data.labels = markets.map(m => m.name);
                charts.market.data.datasets[0].data = markets.map(m => m.count);
                charts.market.update();
            }
        }

        // Toggle collector
        async function toggleCollector() {
            try {
                const endpoint = collectorStatus ? '/api/collector/stop' : '/api/collector/start';
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();
                
                collectorStatus = !collectorStatus;
                updateCollectorButton();
                
                alert(result.message);
            } catch (error) {
                console.error('Error toggling collector:', error);
                alert('Erro ao controlar coletor');
            }
        }

        // Check collector status
        async function checkCollectorStatus() {
            try {
                const response = await fetch('/api/collector/status');
                const status = await response.json();
                collectorStatus = status.running;
                updateCollectorButton();
            } catch (error) {
                console.error('Error checking collector status:', error);
            }
        }

        // Update collector button
        function updateCollectorButton() {
            const button = document.querySelector('button[onclick="toggleCollector()"]');
            if (collectorStatus) {
                button.innerHTML = '<i class="fas fa-stop me-1"></i>Parar Coletor';
                button.className = 'btn btn-outline-danger';
            } else {
                button.innerHTML = '<i class="fas fa-play me-1"></i>Iniciar Coletor';
                button.className = 'btn btn-outline-success';
            }
        }

        // Load predictions
        async function loadPredictions() {
            try {
                const response = await fetch('/api/predictions?limit=100');
                const predictions = await response.json();
                
                const content = document.getElementById('predictions-content');
                content.innerHTML = predictions.map(pred => `
                    <div class="prediction-card p-3 mb-3 ${pred.expected_value < 0 ? 'negative' : ''}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>${pred.match ? pred.match.home_team + ' vs ' + pred.match.away_team : 'N/A'}</h6>
                                <p class="mb-1"><strong>${pred.market}</strong> - ${pred.selection}</p>
                                <small class="text-muted">${pred.match ? pred.match.league : 'N/A'} - ${new Date(pred.created_at).toLocaleString()}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-1">
                                    <span class="${pred.expected_value > 0 ? 'ev-positive' : 'ev-negative'}">
                                        EV: ${(pred.expected_value * 100).toFixed(1)}%
                                    </span>
                                </div>
                                <div class="mb-1">
                                    <small>Confiança: ${(pred.confidence * 100).toFixed(1)}%</small>
                                </div>
                                <div class="mb-1">
                                    <small>Stake: ${(pred.stake_percentage * 100).toFixed(1)}%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading predictions:', error);
            }
        }

        // Load matches
        async function loadMatches() {
            try {
                const response = await fetch('/api/matches?limit=100');
                const matches = await response.json();
                
                const content = document.getElementById('matches-content');
                content.innerHTML = matches.map(match => `
                    <div class="match-card p-3 mb-3">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>${match.home_team} vs ${match.away_team}</h6>
                                <small class="text-muted">${match.league_name} - ${new Date(match.date).toLocaleString()}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-${match.status === 'LIVE' ? 'danger' : match.status === 'NS' ? 'primary' : 'secondary'}">
                                    ${match.status}
                                </span>
                                ${match.home_score !== null ? `<div class="mt-1">${match.home_score} - ${match.away_score}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        // Load performance
        async function loadPerformance() {
            try {
                const response = await fetch('/api/performance');
                const performance = await response.json();
                
                const content = document.getElementById('performance-content');
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card p-3 text-center">
                                <h3>${performance.total_predictions}</h3>
                                <small class="text-muted">Total de Predições</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card p-3 text-center">
                                <h3>${(performance.average_ev * 100).toFixed(1)}%</h3>
                                <small class="text-muted">EV Médio</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card p-3 text-center">
                                <h3>${(performance.average_confidence * 100).toFixed(1)}%</h3>
                                <small class="text-muted">Confiança Média</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card p-3 text-center">
                                <h3>${(performance.success_rate * 100).toFixed(1)}%</h3>
                                <small class="text-muted">Taxa de Sucesso</small>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading performance:', error);
            }
        }

        // Load settings
        function loadSettings() {
            const content = document.getElementById('settings-content');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="stat-card p-3">
                            <h5>Configurações de Análise</h5>
                            <div class="mb-3">
                                <label class="form-label">Confiança Mínima</label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01" value="{{ min_confidence }}" id="minConfidence">
                                <small class="text-muted">Valor atual: {{ (min_confidence * 100)|round(1) }}%</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Confiança Máxima</label>
                                <input type="range" class="form-range" min="0" max="1" step="0.01" value="{{ max_confidence }}" id="maxConfidence">
                                <small class="text-muted">Valor atual: {{ (max_confidence * 100)|round(1) }}%</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">EV Mínimo</label>
                                <input type="range" class="form-range" min="0" max="0.2" step="0.01" value="{{ min_value_ev }}" id="minValueEv">
                                <small class="text-muted">Valor atual: {{ (min_value_ev * 100)|round(1) }}%</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-card p-3">
                            <h5>Status do Sistema</h5>
                            <div class="mb-3">
                                <strong>Coletor:</strong> <span id="collector-status">Verificando...</span>
                            </div>
                            <div class="mb-3">
                                <strong>Última Atualização:</strong> <span id="last-update">${new Date().toLocaleString()}</span>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-primary" onclick="refreshData()">
                                    <i class="fas fa-sync-alt me-1"></i>Atualizar Agora
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update collector status
            checkCollectorStatus().then(() => {
                document.getElementById('collector-status').textContent = collectorStatus ? 'Executando' : 'Parado';
            });
        }

        // Authentication functions
        function showUserProfile() {
            // Implement user profile modal
            alert('Funcionalidade de perfil em desenvolvimento');
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                // Remove tokens from localStorage
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                
                // Redirect to login page
                window.location.href = '/login';
            }
        }

        // API request helper with authentication
        async function apiRequest(url, options = {}) {
            const token = localStorage.getItem('access_token');
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            
            // If token expired, try to refresh
            if (response.status === 401 && token) {
                const refreshed = await refreshToken();
                if (refreshed) {
                    // Retry with new token
                    const newToken = localStorage.getItem('access_token');
                    const retryOptions = {
                        ...options,
                        headers: {
                            ...defaultOptions.headers,
                            'Authorization': `Bearer ${newToken}`
                        }
                    };
                    return fetch(url, retryOptions);
                } else {
                    // Refresh failed, redirect to login
                    window.location.href = '/login';
                    return;
                }
            }
            
            return response;
        }

        // Refresh token function
        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) return false;
            
            try {
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    localStorage.setItem('access_token', result.access_token);
                    localStorage.setItem('refresh_token', result.refresh_token);
                    return true;
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
            }
            
            return false;
        }
    </script>
</body>
</html>
