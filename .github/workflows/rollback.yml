name: üîÑ Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
        - staging
        - production
      version:
        description: 'Version to rollback to (leave empty for previous version)'
        required: false
        type: string

env:
  REGISTRY: docker.io
  IMAGE_NAME: marabet-ai

jobs:
  # Job 1: Rollback Staging
  rollback-staging:
    name: üîÑ Rollback Staging
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîê Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: üîÑ Rollback Staging Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USERNAME }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_PORT }}
        script: |
          cd /opt/marabet-ai/staging
          
          # Determine version to rollback to
          if [ -n "${{ github.event.inputs.version }}" ]; then
            ROLLBACK_VERSION="${{ github.event.inputs.version }}"
          else
            # Get previous version from git tags
            ROLLBACK_VERSION=$(git tag --sort=-version:refname | head -2 | tail -1)
          fi
          
          echo "Rolling back to version: $ROLLBACK_VERSION"
          
          # Stop current deployment
          docker-compose -f docker-compose.staging.yml down || true
          
          # Pull previous version
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$ROLLBACK_VERSION
          
          # Update docker-compose with previous version
          sed -i "s|image:.*|image: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$ROLLBACK_VERSION|g" docker-compose.staging.yml
          
          # Start previous deployment
          docker-compose -f docker-compose.staging.yml up -d
          
          # Wait for services to be ready
          sleep 30
          
          # Health check
          curl -f http://localhost:8000/health || exit 1
          
          echo "Staging rollback completed successfully!"

  # Job 2: Rollback Production
  rollback-production:
    name: üîÑ Rollback Production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment: production
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîê Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: üîÑ Rollback Production Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USERNAME }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: ${{ secrets.PRODUCTION_PORT }}
        script: |
          cd /opt/marabet-ai/production
          
          # Determine version to rollback to
          if [ -n "${{ github.event.inputs.version }}" ]; then
            ROLLBACK_VERSION="${{ github.event.inputs.version }}"
          else
            # Get previous version from git tags
            ROLLBACK_VERSION=$(git tag --sort=-version:refname | head -2 | tail -1)
          fi
          
          echo "Rolling back to version: $ROLLBACK_VERSION"
          
          # Stop current deployment
          docker-compose -f docker-compose.production.yml down || true
          
          # Pull previous version
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$ROLLBACK_VERSION
          
          # Update docker-compose with previous version
          sed -i "s|image:.*|image: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:$ROLLBACK_VERSION|g" docker-compose.production.yml
          
          # Start previous deployment
          docker-compose -f docker-compose.production.yml up -d
          
          # Wait for services to be ready
          sleep 60
          
          # Health check
          curl -f http://localhost:8000/health || exit 1
          
          echo "Production rollback completed successfully!"

  # Job 3: Notifica√ß√£o de Rollback
  notify-rollback:
    name: üì¢ Notify Rollback Status
    runs-on: ubuntu-latest
    needs: [rollback-staging, rollback-production]
    if: always()
    
    steps:
    - name: üì¢ Notify Success
      if: needs.rollback-staging.result == 'success' || needs.rollback-production.result == 'success'
      run: |
        echo "‚úÖ Rollback completed successfully!"
        echo "üîÑ Environment: ${{ github.event.inputs.environment }}"
        echo "üè∑Ô∏è Version: ${{ github.event.inputs.version || 'previous' }}"
    
    - name: üì¢ Notify Failure
      if: needs.rollback-staging.result == 'failure' || needs.rollback-production.result == 'failure'
      run: |
        echo "‚ùå Rollback failed!"
        echo "üîç Please check the logs for details"
        exit 1
