name: ðŸš€ Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - staging-test

env:
  ENVIRONMENT: staging
  REGISTRY: docker.io
  IMAGE_NAME: marabet-ai

jobs:
  # Job 1: Deploy para Staging
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ“‹ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=staging-
        labels: |
          org.opencontainers.image.title=MaraBet AI Staging
          org.opencontainers.image.description=Sistema Profissional de Apostas com IA - Staging
          org.opencontainers.image.vendor=MaraBet
          org.opencontainers.image.version=${{ github.sha }}
          org.opencontainers.image.environment=staging
    
    - name: ðŸ—ï¸ Build Staging Image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_ENV=staging
          VERSION=${{ github.sha }}
    
    - name: ðŸ“ Create Docker Compose for Staging
      run: |
        cat > docker-compose.staging.yml << EOF
        version: '3.8'
        
        services:
          marabet-ai:
            image: ${{ steps.meta.outputs.tags }}
            container_name: marabet-ai-staging
            restart: unless-stopped
            ports:
              - "8000:8000"
              - "8001:8001"
            environment:
              - DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
              - API_FOOTBALL_KEY=${{ secrets.API_FOOTBALL_KEY }}
              - THE_ODDS_API_KEY=${{ secrets.THE_ODDS_API_KEY }}
              - TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
              - TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
              - BUILD_ENV=staging
              - LOG_LEVEL=INFO
            volumes:
              - marabet-staging-data:/app/data
              - marabet-staging-logs:/app/logs
            networks:
              - marabet-staging-network
        
          nginx:
            image: nginx:alpine
            container_name: marabet-nginx-staging
            restart: unless-stopped
            ports:
              - "80:80"
              - "443:443"
            volumes:
              - ./nginx/nginx.staging.conf:/etc/nginx/nginx.conf:ro
              - marabet-ssl-certs:/etc/nginx/ssl:ro
            depends_on:
              - marabet-ai
            networks:
              - marabet-staging-network
        
          prometheus:
            image: prom/prometheus:latest
            container_name: marabet-prometheus-staging
            restart: unless-stopped
            ports:
              - "9090:9090"
            volumes:
              - ./monitoring/prometheus.staging.yml:/etc/prometheus/prometheus.yml:ro
              - marabet-prometheus-data:/prometheus
            command:
              - '--config.file=/etc/prometheus/prometheus.yml'
              - '--storage.tsdb.path=/prometheus'
              - '--web.console.libraries=/etc/prometheus/console_libraries'
              - '--web.console.templates=/etc/prometheus/consoles'
              - '--web.enable-lifecycle'
            networks:
              - marabet-staging-network
        
        volumes:
          marabet-staging-data:
          marabet-staging-logs:
          marabet-ssl-certs:
          marabet-prometheus-data:
        
        networks:
          marabet-staging-network:
            driver: bridge
        EOF
    
    - name: ðŸ“ Create Nginx Config for Staging
      run: |
        mkdir -p nginx
        cat > nginx/nginx.staging.conf << EOF
        events {
            worker_connections 1024;
        }
        
        http {
            upstream marabet_backend {
                server marabet-ai:8000;
            }
            
            server {
                listen 80;
                server_name staging.marabet-ai.com;
                
                location / {
                    proxy_pass http://marabet_backend;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
                
                location /health {
                    proxy_pass http://marabet_backend/health;
                    access_log off;
                }
            }
        }
        EOF
    
    - name: ðŸ“ Create Prometheus Config for Staging
      run: |
        mkdir -p monitoring
        cat > monitoring/prometheus.staging.yml << EOF
        global:
          scrape_interval: 15s
          evaluation_interval: 15s
        
        rule_files:
          - "rules/*.yml"
        
        scrape_configs:
          - job_name: 'marabet-ai'
            static_configs:
              - targets: ['marabet-ai:8000']
            metrics_path: '/metrics'
            scrape_interval: 30s
        
          - job_name: 'nginx'
            static_configs:
              - targets: ['nginx:80']
            metrics_path: '/nginx_status'
            scrape_interval: 30s
        EOF
    
    - name: ðŸš€ Deploy to Staging Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USERNAME }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_PORT }}
        script: |
          # Create staging directory
          mkdir -p /opt/marabet-ai/staging
          cd /opt/marabet-ai/staging
          
          # Stop existing containers
          docker-compose -f docker-compose.staging.yml down || true
          
          # Pull latest image
          docker pull ${{ steps.meta.outputs.tags }}
          
          # Start new deployment
          docker-compose -f docker-compose.staging.yml up -d
          
          # Wait for services to be ready
          sleep 30
          
          # Health check
          curl -f http://localhost:8000/health || exit 1
          
          # Clean up old images
          docker image prune -f
    
    - name: ðŸ§ª Run Staging Tests
      run: |
        # Wait for deployment to be ready
        sleep 60
        
        # Test staging environment
        curl -f http://${{ secrets.STAGING_HOST }}/health || exit 1
        curl -f http://${{ secrets.STAGING_HOST }}/api/health || exit 1
        curl -f http://${{ secrets.STAGING_HOST }}/dashboard || exit 1
    
    - name: ðŸ“Š Update Staging Status
      run: |
        echo "âœ… Staging deployment completed successfully!"
        echo "ðŸŒ Staging URL: http://${{ secrets.STAGING_HOST }}"
        echo "ðŸ“Š Monitoring: http://${{ secrets.STAGING_HOST }}:9090"
        echo "ðŸ·ï¸ Image: ${{ steps.meta.outputs.tags }}"

  # Job 2: NotificaÃ§Ã£o de Deploy
  notify-deploy:
    name: ðŸ“¢ Notify Deploy Status
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always()
    
    steps:
    - name: ðŸ“¢ Notify Success
      if: needs.deploy-staging.result == 'success'
      run: |
        echo "âœ… Staging deployment successful!"
        echo "ðŸŒ Staging URL: http://${{ secrets.STAGING_HOST }}"
        echo "ðŸ“Š Monitoring: http://${{ secrets.STAGING_HOST }}:9090"
    
    - name: ðŸ“¢ Notify Failure
      if: needs.deploy-staging.result == 'failure'
      run: |
        echo "âŒ Staging deployment failed!"
        echo "ðŸ” Please check the logs for details"
        exit 1
